<!DOCTYPE html>
<html lang="en">
<head>…</head>
<body>
  <h1>Now Playing Dashboard</h1>

  <!-- Registration Box -->
  <div id="register-box" style="background:#222;padding:1rem;border-radius:6px;max-width:400px;margin:1rem auto;text-align:center;">
    <h2>Join the Dashboard</h2>
    <label>
      <input type="checkbox" id="consent"> I consent to share my Spotify Now Playing.
    </label><br><br>
    <button id="btnRegister" disabled>Authorize with Spotify</button>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard"></div>

  <script>
    const CLIENT_ID = 'YOUR_SPOTIFY_CLIENT_ID';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = 'user-read-currently-playing';

    //Enable/register button when consent is checked
    document.getElementById('consent').onchange = e => {
      document.getElementById('btnRegister').disabled = !e.target.checked;
    };
    document.getElementById('btnRegister').onclick = () => {
      const authURL = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}` +
        `&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${encodeURIComponent(SCOPES)}`;
      window.location = authURL + '#register';
    };

    function getToken() {
      return window.location.hash.includes('access_token')
        ? Object.fromEntries(new URLSearchParams(window.location.hash.slice(1)))
        : {};
    }

    async function registerUser(token) {
      const name = prompt('Enter the name to display:');
      if (!name) return;
      await fetch('/.netlify/functions/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({name, refreshToken: token})
      });
      alert('Registered! Your track will appear soon.');
      window.location = REDIRECT_URI; // remove hash
    }

    //On load, check if returning from OAuth for registration
    const params = getToken();
    if (window.location.hash.includes('register') && params.access_token) {

      registerUser(params.access_token);
    }
  </script>
</body>
</html>